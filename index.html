<!DOCTYPE html>
<html>
  <!-- STEP 1: Prepare the canvas -->
  <head>
    <style>
      #my_Canvas {
        border: 5px dotted green;
        body,
        html {
          overflow: hidden;
        }
      }
    </style>
    <meta name="viewport" content="width=device-width, user-scalable=no" />
  </head>

  <body>
    <canvas style="width: 90%" width="400" height="400" id="my_Canvas"></canvas>

    <h3 id="marcador">Marcador: 0-0</h3>
    <p>Teclas de control:</p>
    <p>- flecha izquierda: sube jugador 1.</p>
    <p>- flecha derecha: baja jugador 1.</p>
    <p>- 1 arriba: sube jugador 2.</p>
    <p>- 2 abajo: baja jugador 2.</p>

    <!--pop up -->
    <div
      id="popup"
      style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border: 2px solid green;
      "
    >
      <h2 id="popup-text"></h2>
    </div>

    <!-- vertex Shader -->
    <script id="vertex-shader" type="x-shader/x-vertex">
      #version 300 es
      precision mediump float;

      in vec2 aCoordinates;

      void main(void) {
        gl_Position = vec4(aCoordinates, 0, 1);
        gl_PointSize = 10.0;
      }
    </script>

    <!-- fragment Shader -->
    <script id="fragment-shader" type="x-shader/x-fragment">
        #version 300 es
        precision mediump float;

        out vec4 fragColor;
        uniform vec4 uColor;

        void main(void) {
          fragColor = uColor;
      }
    </script>

    <script>
      var colorLocation;
      var canvas;
      var vertex_buffer;

      var ball = {
        x: -0.5,
        y: 0.3,
        width: 0.1,
        height: 0.1,
        color: [0, 0, 1, 1],
        speedX: 0.01,
        speedY: -0.02,
      };

      var player1 = {
        x: -0.8,
        y: 0.3,
        width: 0.1,
        height: 0.4,
        color: [1, 1, 1, 1],
        movement: 0, //0:no me muevo, 1: para arriba, -1: para abajo
      };

      var player2 = {
        x: 0.7,
        y: 0.3,
        width: 0.1,
        height: 0.4,
        color: [1, 1, 1, 1],
        movement: 0, 
      };

      //para el marcador
      var marcador1 = 0;
      var marcador2 = 0;

      function init() {

        // ============ STEP 1: Creating a canvas=================
        canvas = document.getElementById("my_Canvas");
        gl = canvas.getContext("webgl2");

        //========== STEP 2: Create and compile shaders ==========

        // Create a vertex shader object
        var vertShader = gl.createShader(gl.VERTEX_SHADER);

        // Attach vertex shader source code
        var script = document.getElementById("vertex-shader");
        var shaderString = script.text.trim();
        gl.shaderSource(vertShader, shaderString);

        // Compile the vertex shader
        gl.compileShader(vertShader);

        // Create fragment shader object
        var fragShader = gl.createShader(gl.FRAGMENT_SHADER);

        // Attach fragment shader source code
        script = document.getElementById("fragment-shader");
        shaderString = script.text.trim();
        gl.shaderSource(fragShader, shaderString);

        // Compile the fragmentt shader
        gl.compileShader(fragShader);

        // Create a shader program object to store
        // the combined shader program
        var shaderProgram = gl.createProgram();

        // Attach a vertex shader
        gl.attachShader(shaderProgram, vertShader);

        // Attach a fragment shader
        gl.attachShader(shaderProgram, fragShader);

        // Link both programs
        gl.linkProgram(shaderProgram);

        // Use the combined shader program object
        gl.useProgram(shaderProgram);

        //======== STEP 3: Create buffer objects and associate shaders ========

        // Create an empty buffer object to store the vertex buffer
        vertex_buffer = gl.createBuffer();

        // Bind vertex buffer object
        gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

        //get the uniform location
        colorLocation = gl.getUniformLocation(shaderProgram, "uColor");

        //set the color
        //gl.uniform4fv(colorLocation, [1,1,0,1]);

        // Get the attribute location
        var coordLocation = gl.getAttribLocation(shaderProgram, "aCoordinates");

        // Point an attribute to the currently bound VBO
        gl.vertexAttribPointer(coordLocation, 2, gl.FLOAT, false, 0, 0);

        // Enable the attribute
        gl.enableVertexAttribArray(coordLocation);

        // Unbind the buffer
        gl.bindBuffer(gl.ARRAY_BUFFER, null);

        //llama a render
        render();
      }

      function render() {

        //========= STEP 4: Drawing the primitive ===============

        // Clear the canvas
        gl.clearColor(0.7, 0.9, 0.7, 1.0);

        // Clear the color buffer bit
        gl.clear(gl.COLOR_BUFFER_BIT);

        // Set the view port
        gl.viewport(0, 0, canvas.width, canvas.height);

        // Bind appropriate array buffer to it
        gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

        if (ball.y < -1 || ball.y + ball.height > 1) ball.speedY *= -1;
        if (ball.x + ball.width > 1 || ball.x < -1) ball.speedX *= -1;

        ball.x += ball.speedX;
        ball.y += ball.speedY;

        if (player1.y < -1 || player1.y + player1.height > 1)
          player1.movement *= -1;
        if (player2.y < -1 || player2.y + player2.height > 1)
          player2.movement *= -1;

        // Actualiza las posiciones de los jugadores
        player1.y += player1.movement * 0.02;
        player2.y += player2.movement * 0.02;

        drawRectangle(ball); //Pelota

        drawRectangle(player1); //pinto el player1
        drawRectangle(player2); //pinto el player2

        // Comprueba si la bola colisiona con player1
        if (
          ball.x < player1.x + player1.width &&
          ball.x + ball.width > player1.x &&
          ball.y < player1.y + player1.height &&
          ball.y + ball.height > player1.y
        ) {
          // Si hay colisión en el eje y, invierte la velocidad de la bola en el eje x
          ball.speedX *= -1;
        }

        // Comprueba si la bola colisiona con player1
        if (
          ball.x < player2.x + player2.width &&
          ball.x + ball.width > player2.x &&
          ball.y < player2.y + player2.height &&
          ball.y + ball.height > player2.y
        ) {
          // Si hay colisión en el eje y, invierte la velocidad de la bola en el eje x
          ball.speedX *= -1;
        }

        //empezamos a contabilizar los puntos
        if (ball.x + ball.width > 1) {
          marcador1++;
          if (marcador1 >= 10) {
            endGame("Jugador 1");
          } else {
            resetGame();
          }
          updateMarcador();
        } else if (ball.x < -1) {
          marcador2++;
          if (marcador2 >= 10) {
            endGame("Jugador 2");
          } else {
            resetGame();
          }
          updateMarcador();
        }

        // Unbind the buffer
        gl.bindBuffer(gl.ARRAY_BUFFER, null);

        window.requestAnimationFrame(render);
      }

      //Función para añadir pop up
      function endGame(winner) {
        var popup = document.getElementById("popup");
        var popupText = document.getElementById("popup-text");

        popupText.innerHTML = "Ganador: " + winner;
        popup.style.display = "block";

        setTimeout(function () {
          popup.style.display = "none"; 
          if (marcador1 >= 10 || marcador2 >= 10) {
            resetGame(); 
            marcador1 = 0;
            marcador2 = 0;
            updateMarcador();
          }
        }, 30000); // 30 segundos en milisegundos
      }

      //Una vez se termina una partida reseteamos el juego
      function resetGame() {
        ball.x = -0.5;
        ball.y = 0.3;
        ball.speedX = 0.01;
        ball.speedY = -0.02;
        player1.y = 0.3;
        player2.y = 0.3;
        player1.movement = 0;
        player2.movement = 0;
      }
      
      //El marcador
      function updateMarcador() {
        document.getElementById("marcador").innerHTML =
          "Marcador: " + marcador1 + "-" + marcador2;
      }

      function drawRectangle(r) {
        var x1 = r.x;
        var x2 = r.x + r.width;
        var y1 = r.y;
        var y2 = r.y + r.height;
        gl.bufferData(
          gl.ARRAY_BUFFER,
          new Float32Array([x1, y1, x2, y1, x1, y2, x1, y2, x2, y1, x2, y2]),
          gl.STATIC_DRAW
        );

        //Color de fondo
        gl.uniform4fv(colorLocation, r.color);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
      }

      function onKeyDown(key) {
        switch (key.keyCode) {
          case 38: {
            //tecla up
            player1.movement = 1;
            break;
          }

          case 40: {
            //tecla down
            player1.movement = -1;
            break;
          }

          case 49: {
            //tecla 1
            player2.movement = 1;
            break;
          }

          case 51: {
            //tecla 3
            player2.movement = -1;
            break;
          }
        }
      }

      function onKeyUp(key) {
        player1.movement = 0;
        player2.movement = 0;
      }

      // eventos en el móvil
      function onTouchStart(e) {
        touchobj = e.changedTouches[0]; // reference first touch
        prevTouchY = parseInt(touchobj.clientY);
      }

      function onTouchMove(e) {
        touchobj = e.changedTouches[0];
        touchY = parseInt(touchobj.clientY);
        difY = touchY - prevTouchY;
        player1.movement = -difY * 0.4;
        prevTouchY = touchY;
      }

      function onTouchEnd(e) {
        player1.movement = 0;
      }

      //codigo principal
      window.onload = init;
      window.onkeydown = onKeyDown;
      window.onkeyup = onKeyUp;
      window.ontouchstart = onTouchStart;
      window.ontouchmove = onTouchMove;
      window.ontouchend = onTouchEnd;
    </script>
  </body>
</html>