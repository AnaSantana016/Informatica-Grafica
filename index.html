<!DOCTYPE html>
<html>
  <!-- STEP 1: Prepare the canvas -->
  <head>
    <style>
      #my_Canvas {
        border: 5px groove green;
      }
    </style>
  </head>

  <body>
    <canvas width="300" height="400" id="my_Canvas"></canvas>

    <!-- vertex Shader -->
    <script id="vertex-shader" type="x-shader/x-vertex">
      #version 300 es
      precision mediump float;

      in vec2 aCoordinates;

      void main(void) {
        gl_Position = vec4(aCoordinates, 0, 1);
        gl_PointSize = 10.0;
      }
    </script>

    <!-- fragment Shader -->
    <script id="fragment-shader" type="x-shader/x-fragment">
        #version 300 es
        precision mediump float;

        out vec4 fragColor;
        uniform vec4 uColor;

        void main(void) {
          fragColor = uColor;
      }
    </script>

    <script>
      var colorLocation;
      var canvas;
      var vertex_buffer;
      var fila = 0.1;
      var direction = 1;
      var speed = 0.005;

      function init() {
        
        // ============ STEP 1: Creating a canvas=================
        canvas = document.getElementById("my_Canvas");
        gl = canvas.getContext("webgl2");

        //========== STEP 2: Create and compile shaders ==========

        // Create a vertex shader object
        var vertShader = gl.createShader(gl.VERTEX_SHADER);

        // Attach vertex shader source code
        var script = document.getElementById("vertex-shader");
        var shaderString = script.text.trim();
        gl.shaderSource(vertShader, shaderString);

        // Compile the vertex shader
        gl.compileShader(vertShader);

        // Create fragment shader object
        var fragShader = gl.createShader(gl.FRAGMENT_SHADER);

        // Attach fragment shader source code
        script = document.getElementById("fragment-shader");
        shaderString = script.text.trim();
        gl.shaderSource(fragShader, shaderString);

        // Compile the fragmentt shader
        gl.compileShader(fragShader);

        // Create a shader program object to store
        // the combined shader program
        var shaderProgram = gl.createProgram();

        // Attach a vertex shader
        gl.attachShader(shaderProgram, vertShader);

        // Attach a fragment shader
        gl.attachShader(shaderProgram, fragShader);

        // Link both programs
        gl.linkProgram(shaderProgram);

        // Use the combined shader program object
        gl.useProgram(shaderProgram);

        //======== STEP 3: Create buffer objects and associate shaders ========

        // Create an empty buffer object to store the vertex buffer
        vertex_buffer = gl.createBuffer();

        // Bind vertex buffer object
        gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

        //get the uniform location
        colorLocation = gl.getUniformLocation(shaderProgram, "uColor");

        //set the color
        //gl.uniform4fv(colorLocation, [1,1,0,1]);

        // Get the attribute location
        var coordLocation = gl.getAttribLocation(shaderProgram, "aCoordinates");

        // Point an attribute to the currently bound VBO
        gl.vertexAttribPointer(coordLocation, 2, gl.FLOAT, false, 0, 0);

        // Enable the attribute
        gl.enableVertexAttribArray(coordLocation);

        // Unbind the buffer
        gl.bindBuffer(gl.ARRAY_BUFFER, null);

        //llama a render
        render();
      }

      function render() {
        console.log("dentro de render");

        //========= STEP 4: Drawing the primitive ===============

        // Clear the canvas
        gl.clearColor(0.7, 0.9, 0.7, 1.0);

        // Clear the color buffer bit
        gl.clear(gl.COLOR_BUFFER_BIT);

        // Set the view port
        gl.viewport(0, 0, canvas.width, canvas.height);

        // Bind appropriate array buffer to it
        gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

        drawRectangle(gl, -fila, 0.4, 0.3, 0.5, [0, 0, 0, 0]); //Blanco arriba
        drawRectangle(gl, 0.5, -0.2, 0.3, 0.5, [1, 1, 0.5, 1]); //Amarillo derecha
        drawRectangle(gl, -0.1, -0.2, 0.3, 0.5, [0.4, 0.4, 1, 1]); //Azul
        drawRectangle(gl, -0.7, -0.2, 0.3, 0.5, [0, 0, 0, 0]); //Blanco izquierda
        drawRectangle(gl, +fila, -0.8, 0.3, 0.5, [1, 1, 0.5, 1]); //Amarillo abajo

        drawDiamond(gl, -0.67 - fila, 0.45, 0.4, 0.4, [1, 1, 0.5, 1]); //Amarillo izquierda
        drawDiamond(gl, 0.55 - fila, 0.45, 0.4, 0.4, [0.4, 0.4, 1, 1]); //Azul derecha
        drawDiamond(gl, -0.67 + fila, -0.75, 0.4, 0.4, [0.4, 0.4, 1, 1]); //Azul izquierda
        drawDiamond(gl, 0.55 + fila, -0.75, 0.4, 0.4, [0, 0, 0, 0]); //Blanco derecha

        //Actualiza la posición de fila en función de la dirección y velocidad
        fila += direction * speed;

        // Si la fila llega a ciertos límites, cambia la dirección
        if (fila > 2.0 || fila < -2.0) {
          direction *= -1; // Cambia la dirección
        }

        // Unbind the buffer
        gl.bindBuffer(gl.ARRAY_BUFFER, null);

        window.requestAnimationFrame(render);
      }

      function drawRectangle(gl, x, y, width, height, color) {
        var x1 = x;
        var x2 = x + width;
        var y1 = y;
        var y2 = y + height;
        gl.bufferData(
          gl.ARRAY_BUFFER,
          new Float32Array([
            x1, y1, x2, y1, 
            x1, y2, x1, y2, 
            x2, y1, x2, y2]),
          gl.STATIC_DRAW
        );

        //Color de fondo
        gl.uniform4fv(colorLocation, color);
        gl.drawArrays(gl.TRIANGLES, 0, 6);
      }

      function drawDiamond(gl, x, y, width, height, color) {
        var xCenter = x + width / 2;
        var yCenter = y + height / 2;
        var halfWidth = width / 2;
        var halfHeight = height / 2;

        gl.bufferData(
          gl.ARRAY_BUFFER,
          new Float32Array([
            xCenter,
            yCenter + halfHeight,
            xCenter + halfWidth,
            yCenter,
            xCenter,
            yCenter - halfHeight,
            xCenter - halfWidth,
            yCenter,
            xCenter,
            yCenter + halfHeight,
          ]),
          gl.STATIC_DRAW
        );

        gl.uniform4fv(colorLocation, color);
        gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
      }

      //Codigo Principal
      window.onload = init;
    </script>
  </body>
</html>
